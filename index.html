<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador SCORM - Dinámico</title>
    <style>
        #progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            display: none; /* Oculto al principio */
        }

        #progress-bar-fill {
            height: 20px;
            width: 0;
            background-color: #4caf50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
        }

        /* Spinner */
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none; /* Oculto al principio */
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #progress-text {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Generador de Paquetes SCORM</h1>

    <form id="scormForm">
        <!-- Subir el video en formato MP4 -->
        <label for="video">Subir Video (MP4):</label><br>
        <input type="file" id="video" accept=".mp4"><br><br>

        <!-- Subir imágenes de las fichas en formato JPG -->
        <label for="fichas">Subir Fichas (JPG):</label><br>
        <input type="file" id="fichas" accept=".jpg" multiple><br><br>

        <!-- Subir la actividad en formato PDF -->
        <label for="pdf">Subir Actividad (PDF):</label><br>
        <input type="file" id="pdf" accept=".pdf"><br><br>

        <!-- Subir la build de Unity en formato ZIP -->
        <label for="unityZip">Subir Build de Unity (ZIP):</label><br>
        <input type="file" id="unityZip" accept=".zip"><br><br>

        <!-- Botón para generar el ZIP -->
        <button type="button" onclick="generarSCORM()">Generar Paquete SCORM</button>
    </form>

    <div class="loader" id="loader"></div> <!-- Spinner para mostrar durante la generación -->

    <div id="progress-bar">
        <div id="progress-bar-fill">0%</div>
    </div>

    <p id="progress-text"></p>

    <!-- Incluir la librería JSZip para manejar archivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip-utils@0.1.0/dist/jszip-utils.min.js"></script>
    
    <script>
        async function generarSCORM() {
            const progressElement = document.getElementById("progress-text");
            const progressBar = document.getElementById("progress-bar-fill");
            const progressContainer = document.getElementById("progress-bar");
            const loader = document.getElementById("loader");

            // Mostrar el spinner y la barra de progreso al iniciar
            loader.style.display = "block";
            progressContainer.style.display = "block";

            progressElement.textContent = "Iniciando la generación del SCORM...";
            progressBar.style.width = "0%";
            progressBar.textContent = "0%";

            let zip = new JSZip();
            let scormFolder = zip.folder("scorm_package");

            let totalSize = 0;  // Tamaño total del ZIP
            let processedSize = 0;  // Tamaño procesado

            // 1. Agregar el archivo index.html para el video
            let videoFile = document.getElementById("video").files[0];
            if (videoFile) {
                totalSize += videoFile.size; // Agregar tamaño del archivo al total
                scormFolder.folder("video").file(videoFile.name, videoFile);
                const videoHtml = await fetch('video_template.html').then(res => res.text());
                scormFolder.file("video.html", videoHtml.replace("video.mp4", videoFile.name));
            }

            // 2. Agregar el archivo index.html para las fichas
            let fichaFiles = document.getElementById("fichas").files;
            if (fichaFiles.length > 0) {
                let fichaFolder = scormFolder.folder("ficha");
                const fichaHtml = await fetch('ficha_template.html').then(res => res.text());
                for (let i = 0; i < fichaFiles.length; i++) {
                    totalSize += fichaFiles[i].size; // Agregar tamaño del archivo al total
                    fichaFolder.file(fichaFiles[i].name, fichaFiles[i]);
                }
                scormFolder.file("ficha.html", fichaHtml);
            }

            // 3. Agregar el archivo index.html para el PDF de actividad
            let pdfFile = document.getElementById("pdf").files[0];
            if (pdfFile) {
                totalSize += pdfFile.size; // Agregar tamaño del archivo al total
                scormFolder.folder("actividad").file(pdfFile.name, pdfFile);
                const pdfHtml = await fetch('pdf_template.html').then(res => res.text());
                scormFolder.file("pdf.html", pdfHtml.replace("actividad.pdf", pdfFile.name));
            }

            // 4. Procesar el archivo ZIP de la build de Unity
            let unityZipFile = document.getElementById("unityZip").files[0];
            if (unityZipFile) {
                totalSize += unityZipFile.size; // Agregar tamaño del archivo al total
                const unityZipContent = await JSZip.loadAsync(unityZipFile);
                let buildFolder = scormFolder.folder("Build");

                let totalFiles = Object.keys(unityZipContent.files).length;
                let count = 0;

                for (const [relativePath, file] of Object.entries(unityZipContent.files)) {
                    if (!file.dir) {
                        const fileData = await file.async("blob");
                        buildFolder.file(relativePath, fileData);
                        count++;
                        processedSize += fileData.size; // Actualizar tamaño procesado
                        let progressPercentage = Math.round((processedSize / totalSize) * 100);
                        progressBar.style.width = `${progressPercentage}%`;
                        progressBar.textContent = `${progressPercentage}%`;
                    }
                }
            }

            // Crear imsmanifest.xml
            let manifestXML = `<?xml version="1.0" encoding="UTF-8"?>
            <manifest identifier="curso-scorm" version="1.0"
                xmlns="http://www.imsglobal.org/xsd/imscp_v1p1">
                <metadata>
                    <schema>ADL SCORM</schema>
                    <schemaversion>1.2</schemaversion>
                </metadata>
                <organizations default="org_1">
                    <organization identifier="org_1">
                        <title>Curso SCORM</title>
                        <item identifier="item_1" identifierref="resource_1">
                            <title>Curso SCORM</title>
                        </item>
                    </organization>
                </organizations>
                <resources>
                    <resource identifier="resource_1" type="webcontent" href="index.html">
                        <file href="index.html"/>
                    </resource>
                </resources>
            </manifest>`;
            scormFolder.file("imsmanifest.xml", manifestXML);

            // Generar el archivo ZIP y descargarlo
            try {
                const blob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "scorm_package.zip";

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                progressElement.textContent = "Paquete SCORM generado y descargado.";
                progressBar.style.width = "100%";
                progressBar.textContent = "100%";
            } catch (error) {
                progressElement.textContent = "Error al generar el paquete SCORM.";
                console.error(error);
            } finally {
                // Ocultar spinner al final
                loader.style.display = "none";
            }
        }
    </script>
</body>
</html>
