<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador SCORM - v2</title> <!-- Versión Actualizada -->
    <style>
        #progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }

        #progress-bar-fill {
            height: 20px;
            width: 0;
            background-color: #4caf50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Generador de Paquetes SCORM</h1>

    <form id="scormForm">
        <!-- Subir el video en formato MP4 -->
        <label for="video">Subir Video (MP4):</label><br>
        <input type="file" id="video" accept=".mp4"><br><br>

        <!-- Subir imágenes de las fichas en formato JPG -->
        <label for="fichas">Subir Fichas (JPG):</label><br>
        <input type="file" id="fichas" accept=".jpg" multiple><br><br>

        <!-- Subir la actividad en formato PDF -->
        <label for="pdf">Subir Actividad (PDF):</label><br>
        <input type="file" id="pdf" accept=".pdf"><br><br>

        <!-- Subir la build de Unity en formato ZIP -->
        <label for="unityZip">Subir Build de Unity (ZIP):</label><br>
        <input type="file" id="unityZip" accept=".zip"><br><br>

        <!-- Botón para generar el ZIP -->
        <button type="button" onclick="generarSCORM()">Generar Paquete SCORM</button>
    </form>

    <div id="progress-bar">
        <div id="progress-bar-fill">0%</div>
    </div>
    <p id="progress-text"></p>

    <!-- Incluir la librería JSZip para manejar archivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip-utils@0.1.0/dist/jszip-utils.min.js"></script>
    
    <script>
        // Corregir la función para evitar "generarSCORM is not defined"
        async function generarSCORM() {
            const progressElement = document.getElementById("progress-text");
            const progressBar = document.getElementById("progress-bar-fill");

            progressElement.textContent = "Iniciando la generación del SCORM...";
            progressBar.style.width = "0%";
            progressBar.textContent = "0%";

            let zip = new JSZip();
            let scormFolder = zip.folder("scorm_package");

            // 1. Crear el archivo index.html para el video
            let videoFile = document.getElementById("video").files[0];
            if (videoFile) {
                scormFolder.folder("video").file(videoFile.name, videoFile);
                let videoHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Video Explicativo</title>
                    <meta charset="utf-8">
                </head>
                <body>
                    <h1>Video Explicativo</h1>
                    <video controls width="100%">
                        <source src="video/${videoFile.name}" type="video/mp4">
                        Tu navegador no soporta la reproducción de video.
                    </video>
                </body>
                </html>`;
                scormFolder.file("video.html", videoHtml);
            }

            // 2. Crear el archivo index.html para las fichas
            let fichaFiles = document.getElementById("fichas").files;
            if (fichaFiles.length > 0) {
                let fichaFolder = scormFolder.folder("ficha");
                let fichaHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Ficha</title>
                    <meta charset="utf-8">
                    <style>
                        .carousel-container {
                            position: relative;
                            max-width: 100%;
                            margin: auto;
                            max-height: 450px;
                            overflow: hidden;
                        }
                        .carousel-slide {
                            display: none;
                            text-align: center;
                        }
                        .carousel-slide img {
                            max-width: 100%;
                            height: auto;
                            max-height: 450px;
                        }
                        .prev, .next {
                            cursor: pointer;
                            position: absolute;
                            top: 50%;
                            width: auto;
                            margin-top: -22px;
                            padding: 16px;
                            color: #cccccc;
                            font-weight: bold;
                            font-size: 18px;
                            transition: 0.6s ease;
                            border-radius: 0 3px 3px 0;
                            user-select: none;
                        }
                        .next {
                            right: 0;
                            border-radius: 3px 0 0 3px;
                        }
                        .prev {
                            left: 0;
                        }
                        .prev.disabled, .next.disabled {
                            visibility: hidden;
                        }
                        .active, .prev:hover, .next:hover {
                            background-color: rgba(0, 0, 0, 0.3);
                        }
                    </style>
                </head>
                <body>
                    <h1>Ficha</h1>
                    <div class="carousel-container">`;

                for (let i = 0; i < fichaFiles.length; i++) {
                    fichaFolder.file(fichaFiles[i].name, fichaFiles[i]);
                    fichaHtml += `
                    <div class="carousel-slide">
                        <img src="ficha/${fichaFiles[i].name}" alt="Ficha ${i + 1}">
                    </div>`;
                }

                fichaHtml += `
                    <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
                    <a class="next" onclick="changeSlide(1)">&#10095;</a>
                    </div>

                    <script>
                        let slideIndex = 0;
                        showSlides(slideIndex);

                        function changeSlide(n) {
                            showSlides(slideIndex += n);
                        }

                        function showSlides(n) {
                            let slides = document.getElementsByClassName('carousel-slide');
                            let prevBtn = document.querySelector('.prev');
                            let nextBtn = document.querySelector('.next');

                            if (n >= slides.length - 1) {
                                slideIndex = slides.length - 1;
                                nextBtn.classList.add('disabled');
                            } else {
                                nextBtn.classList.remove('disabled');
                            }

                            if (n <= 0) {
                                slideIndex = 0;
                                prevBtn.classList.add('disabled');
                            } else {
                                prevBtn.classList.remove('disabled');
                            }

                            for (let i = 0; i < slides.length; i++) {
                                slides[i].style.display = 'none';
                            }

                            slides[slideIndex].style.display = 'block';
                        }
                    </script>
                </body>
                </html>`;
                scormFolder.file("ficha.html", fichaHtml); // Cierre del bloque HTML de las fichas
            }

            // 3. Crear el archivo index.html para el PDF de actividad
            let pdfFile = document.getElementById("pdf").files[0];
            if (pdfFile) {
                scormFolder.folder("actividad").file(pdfFile.name, pdfFile);
                let pdfHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Actividad PDF</title>
                    <meta charset="utf-8">
                </head>
                <body>
                    <h1>Actividad PDF</h1>
                    <iframe src="actividad/${pdfFile.name}" width="100%" height="600px"></iframe>
                </body>
                </html>`;
                scormFolder.file("pdf.html", pdfHtml);
            }

            // 4. Procesar el archivo ZIP de la build de Unity
            let unityZipFile = document.getElementById("unityZip").files[0];
            if (unityZipFile) {
                const unityZipContent = await JSZip.loadAsync(unityZipFile);
                let buildFolder = scormFolder.folder("Build");

                let totalFiles = Object.keys(unityZipContent.files).length;
                let count = 0;

                for (const [relativePath, file] of Object.entries(unityZipContent.files)) {
                    if (!file.dir) {
                        const fileData = await file.async("blob");
                        buildFolder.file(relativePath, fileData);
                        count++;
                        let progressPercentage = Math.round((count / totalFiles) * 100);
                        progressBar.style.width = `${progressPercentage}%`;
                        progressBar.textContent = `${progressPercentage}%`;
                    }
                }
            }

            // Crear imsmanifest.xml
            let manifestXML = `<?xml version="1.0" encoding="UTF-8"?>
            <manifest identifier="curso-scorm" version="1.0"
                xmlns="http://www.imsglobal.org/xsd/imscp_v1p1">
                <metadata>
                    <schema>ADL SCORM</schema>
                    <schemaversion>1.2</schemaversion>
                </metadata>
                <organizations default="org_1">
                    <organization identifier="org_1">
                        <title>Curso SCORM</title>
                        <item identifier="item_1" identifierref="resource_1">
                            <title>Curso SCORM</title>
                        </item>
                    </organization>
                </organizations>
                <resources>
                    <resource identifier="resource_1" type="webcontent" href="index.html">
                        <file href="index.html"/>
                    </resource>
                </resources>
            </manifest>`;
            scormFolder.file("imsmanifest.xml", manifestXML);

            // Generar el archivo ZIP y descargarlo
            try {
                const blob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "scorm_package.zip";

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                progressElement.textContent = "Paquete SCORM generado y descargado.";
                progressBar.style.width = "100%";
                progressBar.textContent = "100%";
            } catch (error) {
                progressElement.textContent = "Error al generar el paquete SCORM.";
                console.error(error);
            }
        }
    </script>
</body>
</html>
