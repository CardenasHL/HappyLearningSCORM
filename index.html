<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador SCORM - Dinámico y Optimizado</title>
    <style>
        #progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            display: none; /* Oculto al principio */
        }

        #progress-bar-fill {
            height: 20px;
            width: 0;
            background-color: #4caf50;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
        }

        /* Spinner */
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none; /* Oculto al principio */
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #progress-text {
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Generador de Paquetes SCORM</h1>

    <form id="scormForm">
        <!-- Subir el video en formato MP4 -->
        <label for="video">Subir Video (MP4):</label><br>
        <input type="file" id="video" accept=".mp4"><br><br>

        <!-- Subir imágenes de las fichas en formato JPG -->
        <label for="fichas">Subir Fichas (JPG):</label><br>
        <input type="file" id="fichas" accept=".jpg" multiple><br><br>

        <!-- Subir la actividad en formato PDF -->
        <label for="pdf">Subir Actividad (PDF):</label><br>
        <input type="file" id="pdf" accept=".pdf"><br><br>

        <!-- Subir la build de Unity en formato ZIP -->
        <label for="unityZip">Subir Build de Unity (ZIP):</label><br>
        <input type="file" id="unityZip" accept=".zip"><br><br>

        <!-- Botón para generar el ZIP -->
        <button type="button" onclick="generarSCORM()">Generar Paquete SCORM</button>
    </form>

    <div class="loader" id="loader"></div> <!-- Spinner para mostrar durante la generación -->

    <div id="progress-bar">
        <div id="progress-bar-fill">0%</div>
    </div>

    <p id="progress-text"></p>

    <!-- Incluir la librería JSZip para manejar archivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip-utils@0.1.0/dist/jszip-utils.min.js"></script>
    
    <script>
        async function generarSCORM() {
            const progressElement = document.getElementById("progress-text");
            const progressBar = document.getElementById("progress-bar-fill");
            const progressContainer = document.getElementById("progress-bar");
            const loader = document.getElementById("loader");

            // Mostrar el spinner y la barra de progreso al iniciar
            loader.style.display = "block";
            progressContainer.style.display = "block";

            progressElement.textContent = "Iniciando la generación del SCORM...";
            progressBar.style.width = "0%";
            progressBar.textContent = "0%";

            let zip = new JSZip();
            let scormFolder = zip.folder("scorm_package");

            let totalSize = 0;  // Tamaño total del ZIP
            let processedSize = 0;  // Tamaño procesado

            // Procesar y agregar recursos al SCORM
            let videoFile = document.getElementById("video").files[0];
            let fichaFiles = document.getElementById("fichas").files;
            let pdfFile = document.getElementById("pdf").files[0];
            let unityZipFile = document.getElementById("unityZip").files[0];

            totalSize = calcularTamañoTotal(videoFile, fichaFiles, pdfFile, unityZipFile); // Función para calcular el tamaño total

            let steps = [
                () => agregarVideo(scormFolder, videoFile),
                () => agregarFichas(scormFolder, fichaFiles),
                () => agregarPDF(scormFolder, pdfFile),
                () => procesarUnityZip(scormFolder, unityZipFile),
                () => generarManifest(scormFolder, fichaFiles),
                () => generarZIP(zip)
            ];

            // Ejecutar los pasos de forma secuencial y actualizar el progreso
            for (let i = 0; i < steps.length; i++) {
                await steps[i]();
                actualizarProgreso(i, steps.length);
            }

            // Actualizar el progreso al 100% y ocultar el spinner
            finalizarProceso();

            // Función para calcular el tamaño total de los archivos
            function calcularTamañoTotal(videoFile, fichaFiles, pdfFile, unityZipFile) {
                let size = 0;
                if (videoFile) size += videoFile.size;
                for (let i = 0; i < fichaFiles.length; i++) {
                    size += fichaFiles[i].size;
                }
                if (pdfFile) size += pdfFile.size;
                if (unityZipFile) size += unityZipFile.size;
                return size;
            }

            // Función para actualizar el progreso
            function actualizarProgreso(pasoActual, totalPasos) {
                let progressPercentage = Math.round(((pasoActual + 1) / totalPasos) * 100);
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.textContent = `${progressPercentage}%`;
                progressElement.textContent = `Progreso: ${progressPercentage}%`;
            }

            // Función para finalizar el proceso
            function finalizarProceso() {
                loader.style.display = "none";
                progressBar.style.width = "100%";
                progressBar.textContent = "100%";
                progressElement.textContent = "Paquete SCORM generado y descargado.";
            }

            // Agregar video al SCORM
            async function agregarVideo(scormFolder, videoFile) {
                if (videoFile) {
                    scormFolder.folder("video").file(videoFile.name, videoFile);
                    const videoHtml = await fetch('video_template.html').then(res => res.text());
                    scormFolder.file("video.html", videoHtml.replace("video.mp4", videoFile.name));
                }
            }

            // Agregar fichas al SCORM
            async function agregarFichas(scormFolder, fichaFiles) {
                if (fichaFiles.length > 0) {
                    let fichaFolder = scormFolder.folder("ficha");
                    const fichaHtml = await fetch('ficha_template.html').then(res => res.text());
                    for (let i = 0; i < fichaFiles.length; i++) {
                        fichaFolder.file(fichaFiles[i].name, fichaFiles[i]);
                    }
                    scormFolder.file("ficha.html", fichaHtml);
                }
            }

            // Agregar PDF de actividad al SCORM
            async function agregarPDF(scormFolder, pdfFile) {
                if (pdfFile) {
                    scormFolder.folder("actividad").file(pdfFile.name, pdfFile);
                    const pdfHtml = await fetch('pdf_template.html').then(res => res.text());
                    scormFolder.file("pdf.html", pdfHtml.replace("actividad.pdf", pdfFile.name));
                }
            }

            // Procesar archivo ZIP de Unity
            async function procesarUnityZip(scormFolder, unityZipFile) {
                if (unityZipFile) {
                    const unityZipContent = await JSZip.loadAsync(unityZipFile);
                    let buildFolder = scormFolder.folder("Build");

                    for (const [relativePath, file] of Object.entries(unityZipContent.files)) {
                        if (!file.dir) {
                            const fileData = await file.async("blob");
                            buildFolder.file(relativePath, fileData);
                        }
                    }
                }
            }

            // Generar el manifest
            function generarManifest(scormFolder, fichaFiles) {
                let manifestXML = `<?xml version="1.0" encoding="UTF-8"?>
                <manifest xmlns="http://www.imsglobal.org/xsd/imscp_v1p1" identifier="curso-completo" version="1.0">
                    <metadata>
                        <schema>ADL SCORM</schema>
                        <schemaversion>1.2</schemaversion>
                    </metadata>
                    <organizations default="org_1">
                        <organization identifier="org_1">
                            <title>Curso Completo: Video, Ficha, Juego y Actividad</title>
                            <item identifier="item_video" identifierref="resource_video">
                                <title>Video Explicativo</title>
                            </item>
                            <item identifier="item_ficha" identifierref="resource_ficha">
                                <title>Ficha Didáctica (Imágenes)</title>
                            </item>
                            <item identifier="item_juego" identifierref="resource_juego">
                                <title>Juego Interactivo (Unity)</title>
                            </item>
                            <item identifier="item_pdf" identifierref="resource_pdf">
                                <title>Actividad PDF para Descargar</title>
                            </item>
                        </organization>
                    </organizations>
                    <resources>
                        <resource identifier="resource_video" type="webcontent" href="video.html">
                            <file href="video/video.mp4"/>
                            <file href="video.html"/>
                        </resource>
                        <resource identifier="resource_ficha" type="webcontent" href="ficha.html">
                            ${Array.from(fichaFiles).map((file) => `<file href="ficha/${file.name}"/>`).join('')}
                            <file href="ficha.html"/>
                        </resource>
                        <resource identifier="resource_juego" type="webcontent" href="index.html">
                            <file href="index.html"/>
                            <file href="Build/BuildESP_SCORM.loader.js"/>
                            <file href="Build/BuildESP_SCORM.data.unityweb"/>
                            <file href="Build/BuildESP_SCORM.framework.js.unityweb"/>
                            <file href="Build/BuildESP_SCORM.wasm.unityweb"/>
                        </resource>
                        <resource identifier="resource_pdf" type="webcontent" href="actividad/actividad.pdf">
                            <file href="actividad/actividad.pdf"/>
                        </resource>
                    </resources>
                </manifest>`;
                scormFolder.file("imsmanifest.xml", manifestXML);
            }

            // Generar el ZIP y descargar
            async function generarZIP(zip) {
                const blob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "scorm_package.zip";

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
